<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Marina & Jaime ‚Äî 04.09.2027</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;1,400&family=Montserrat:wght@300;400;500;600&family=Fredoka+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <style>
        :root {
            --pink: #ff7eb3;
            --accent: #a68e74; 
            --bg-color: #ededed;
            --text-color: #2d2d2d;
            --white: #ffffff;
            --success: #d4edda;
            --success-text: #155724;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow-x: hidden; width: 100%; }

        /* ================= FASE 1: LOS MINIJUEGOS ================= */
        #game-container {
            position: fixed; inset: 0; z-index: 9999;
            background: #fff8f2; display: flex; align-items: center; justify-content: center;
            transition: opacity 0.6s ease-out;
            touch-action: none; 
        }
        .screen {
            display: none; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%; text-align: center; padding: 25px; position: absolute;
        }
        .screen.active { display: flex; animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        h1.game-title { font-family: 'Fredoka One', cursive; color: var(--pink); font-size: 2.2rem; margin-bottom: 10px; }
        p.romantic-text { font-style: italic; color: #777; margin-bottom: 25px; font-size: 1rem; max-width: 320px; line-height: 1.4; }
        .instruction-text { font-size: 0.7rem; color: #aaa; margin-top: 25px; text-transform: uppercase; letter-spacing: 1px; }

        .tinder-card { width: 280px; height: 400px; background: white; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border: 10px solid white; cursor: grab; position: relative; overflow: hidden; touch-action: none; }
        .card-photo { width: 100%; height: 80%; background: #ffe3e3 url('https://via.placeholder.com/300x400?text=VUESTRA+FOTO') center/cover; }
        
        .handheld { width: 320px; height: 180px; background: #ff4757; border-radius: 30px; display: flex; padding: 15px; align-items: center; gap: 15px; box-shadow: 0 10px 0 #cc2e3b; }
        .handheld button { width: 50px; height: 50px; border-radius: 50%; border: none; background: #2f3542; color: white; font-family: 'Fredoka One'; font-size: 1.2rem; cursor: pointer; touch-action: manipulation; }
        .mini-screen { flex: 1; height: 130px; background: #7bed9f; position: relative; border: 5px solid #2f3542; overflow: hidden; border-radius: 10px; }
        .pixel-car { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); font-size: 2.5rem; transition: bottom 0.2s; }

        .bowling-lane { width: 240px; height: 320px; background: #f1f2f6; border-radius: 20px; position: relative; border-bottom: 15px solid #dfe4ea; overflow: hidden; }
        .pins { display: flex; justify-content: center; gap: 12px; margin-top: 40px; font-size: 2.2rem; }
        .bowling-ball-css { width: 55px; height: 55px; background: radial-gradient(circle at 30% 30%, #747d8c, #2f3542); border-radius: 50%; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); cursor: pointer; transition: bottom 0.6s; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

        .gym-bar { width: 260px; height: 35px; background: #f1f2f6; border-radius: 20px; border: 4px solid #ced4da; overflow: hidden; margin: 25px 0; }
        #gym-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #ff7eb3, #ff4757); transition: width 0.3s; }

        .map-area { width: 330px; height: 330px; background: #70a1ff; border-radius: 30px; position: relative; border: 6px solid white; overflow: hidden; }
        .italy-svg { position: absolute; right: 20px; top: 40px; width: 140px; fill: #eccc68; }
        #plane { position: absolute; left: 20px; top: 150px; font-size: 3.2rem; cursor: move; z-index: 1000; touch-action: none; }

        /* ================= SOBRE ================= */
        #transition-stage { position: fixed; inset: 0; z-index: 10000; background: var(--bg-color); display: none; align-items: center; justify-content: center; pointer-events: none; opacity: 0; transition: opacity 0.5s ease-in-out; }
        .envelope-wrapper { position: relative; width: 320px; height: 220px; perspective: 1200px; transform: translateZ(0); }
        .envelope-lid { position: absolute; top: 0; left: 0; width: 100%; height: 50%; background: var(--accent); clip-path: polygon(0 0, 100% 0, 50% 50%); z-index: 30; transform-origin: top; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); backface-visibility: hidden; }
        .envelope-front { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: var(--accent); clip-path: polygon(0 100%, 100% 100%, 100% 0, 50% 50%, 0 0); z-index: 20; filter: brightness(0.9); backface-visibility: hidden; }
        .card-inside { position: absolute; bottom: 5px; left: 5%; width: 90%; height: 95%; background: #fffdf5; z-index: 15; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; text-align: center; border: 1px solid #ddd; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 1.2s cubic-bezier(0.19, 1, 0.22, 1); backface-visibility: hidden; will-change: transform; }
        .envelope-wrapper.open .envelope-lid { transform: rotateX(180deg); z-index: 10; }
        .envelope-wrapper.open .card-inside { transform: translate3d(0, -150px, 0) scale(1.05); }

        /* ================= FASE 3: INVITACI√ìN FINAL ================= */
        #invitation-container { display: none; opacity: 0; transition: opacity 1s; position: relative; z-index: 1; touch-action: auto !important; }
        .grain-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url('Gemini_Generated_Image_32kd4932kd4932kd.jpg'); background-size: cover; background-position: center; filter: grayscale(100%) brightness(1.1) opacity(0.12); z-index: -2; pointer-events: none; }
        
        h1, h2, h3, .serif { font-family: 'Playfair Display', serif; font-weight: 400; }
        nav { position: fixed; top: 0; width: 100%; padding: 15px 0; background: rgba(237, 237, 237, 0.9); backdrop-filter: blur(12px); z-index: 1000; text-align: center; border-bottom: 1px solid rgba(0,0,0,0.05); overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; display: flex; justify-content: center; pointer-events: auto !important; }
        @media (max-width: 600px) { nav { justify-content: flex-start; padding: 15px 10px; } }
        nav a { text-decoration: none; color: var(--text-color); margin: 0 15px; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 2px; font-weight: 600; flex: 0 0 auto; pointer-events: auto !important; }

        header.main-invitation-header { height: 60vh; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; background: linear-gradient(rgba(0,0,0,0.15), rgba(0,0,0,0.25)), url('foto_portada.jpg') center 70% / cover no-repeat; color: var(--white); padding: 20px; margin-top: 50px; }
        header.main-invitation-header h1 { font-size: clamp(2.5rem, 8vw, 4rem); margin: 0; text-shadow: 0 4px 20px rgba(0,0,0,0.4); }

        section.inv-section { max-width: 1100px; margin: 40px auto; padding: 0 20px; text-align: center; }
        .section-title { font-size: 1.8rem; margin-bottom: 20px; }
        .section-title::after { content: ""; display: block; width: 40px; height: 1px; background: var(--accent); margin: 10px auto; }
        .story-text { max-width: 800px; margin: 30px auto; font-size: 1rem; line-height: 1.8; color: #444; text-align: center; }

        .carousel-outer { position: relative; overflow: hidden; width: 100%; margin: 30px 0; padding: 0 45px; }
        .carousel-track { display: flex; overflow-x: auto; gap: 20px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory; scrollbar-width: none; }
        .carousel-track::-webkit-scrollbar { display: none; }
        .photo-card { min-width: 280px; height: 360px; object-fit: cover; border-radius: 4px; filter: grayscale(15%); scroll-snap-align: start; }
        .msg-card { min-width: 300px; background: var(--white); padding: 30px; border-radius: 4px; text-align: left; border-left: 3px solid var(--accent); box-shadow: 0 8px 20px rgba(0,0,0,0.03); scroll-snap-align: start; }
        
        .carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 35px; height: 35px; border-radius: 50%; background: var(--white); border: 1px solid #eee; color: var(--accent); cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .carousel-btn.prev { left: 5px; }
        .carousel-btn.next { right: 5px; }

        .celebracion-info { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 40px; }
        @media (max-width: 768px) { .celebracion-info { grid-template-columns: 1fr; } }
        .info-card { background: rgba(255,255,255,0.6); padding: 30px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05); text-align: left; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .info-title { font-family: 'Playfair Display', serif; font-size: 1.2rem; color: var(--accent); font-weight: bold; margin-bottom: 15px; display: block; }
        .bus-routes-list { list-style: none; padding: 0; margin-top: 10px; }
        .bus-routes-list li { margin-bottom: 22px; font-size: 0.9rem; line-height: 1.6; border-left: 2px solid var(--accent); padding-left: 15px; }
        .bus-routes-list b { color: var(--accent); display: block; text-transform: uppercase; font-size: 0.75rem; margin-bottom: 6px; letter-spacing: 1px; }

        /* NUEVA SECCI√ìN DE TIPS */
        .tips-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px; }
        @media (max-width: 768px) { .tips-grid { grid-template-columns: 1fr; } }
        .tip-item { padding: 20px; background: rgba(255,255,255,0.5); border-radius: 8px; text-align: center; }
        .tip-item i { font-size: 1.8rem; color: var(--accent); margin-bottom: 10px; display: block; }
        .tip-item h4 { font-family: 'Playfair Display', serif; font-size: 1rem; margin-bottom: 8px; }
        .tip-item p { font-size: 0.85rem; color: #555; line-height: 1.5; }

        .rsvp-section { padding: 40px 20px; background: rgba(255,255,255,0.4); margin: 20px auto; border-radius: 4px; text-align: center; }
        .btn-rsvp { background: var(--accent); color: white; border: none; padding: 18px 50px; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 3px; cursor: pointer; transition: 0.4s; border-radius: 4px; pointer-events: auto !important; }
        .wa-button { background: white; border: 1px solid #ddd; padding: 15px 25px; text-decoration: none; color: var(--text-color); font-size: 0.75rem; text-transform: uppercase; font-weight: 600; display: inline-flex; align-items: center; border-radius: 50px; transition: 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin: 5px; }
        .wa-button i { color: #25D366; font-size: 1.4rem; margin-right: 10px; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 30000; padding: 20px; }
        .modal-body { width: 100%; max-width: 480px; max-height: 85vh; background: white; padding: 30px; border-radius: 8px; position: relative; overflow-y: auto; text-align: center; }
        .modal-body label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; color: var(--accent); display: block; margin-top: 15px; margin-bottom: 4px; text-align: left; }
        
        input, select, textarea { 
            width: 100%; padding: 10px 0; margin-bottom: 12px; border: none; 
            border-bottom: 1px solid #ddd; background: transparent; outline: none; 
            font-family: inherit; font-size: 16px !important; 
            pointer-events: auto !important; -webkit-user-select: text !important;
        }

        .member-accordion { border: 1px solid #f0f0f0; border-radius: 8px; margin-bottom: 10px; overflow: hidden; text-align: left; }
        .member-header { background: #fafafa; padding: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: 600; color: var(--accent); font-size: 0.9rem; }
        .member-header.completed { background: var(--success) !important; color: var(--success-text) !important; }
        .member-content { padding: 15px; display: none; background: white; border-top: 1px solid #f0f0f0; }
        .member-content.open { display: block; }
        .btn-copy-settings { background: none; border: 1px dashed var(--accent); color: var(--accent); font-size: 0.6rem; padding: 6px 12px; cursor: pointer; margin-top: 10px; text-transform: uppercase; border-radius: 4px; width: 100%; }
        .spinner { display: none; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="game-container">
    <div class="screen active" id="game-s1">
        <h1 class="game-title">Donde todo comenz√≥... ‚ù§Ô∏è</h1>
        <p class="romantic-text">Un desliz a la derecha que nos cambi√≥ la vida para siempre.</p>
        <div class="tinder-card" id="tinderCard"><div class="card-photo"></div></div>
        <p class="instruction-text">Desliza la tarjeta a la derecha</p>
    </div>
    <div class="screen" id="game-s2">
        <h1 class="game-title">Nuestras viciadas üéÆ</h1>
        <p class="romantic-text">Entre partidas y piques sanos, nuestro amor no paraba de correr.</p>
        <div class="handheld">
            <button onpointerdown="drive(event)">A</button>
            <div class="mini-screen"><div class="pixel-car" id="pCar">üèéÔ∏è</div></div>
            <button onpointerdown="drive(event)">B</button>
        </div>
        <p class="instruction-text">Pulsa los botones A y B para avanzar</p>
    </div>
    <div class="screen" id="game-s3">
        <h1 class="game-title">¬°Pleno al coraz√≥n! Bowling üé≥</h1>
        <p class="romantic-text">Esa tarde de bolos donde supimos que √©ramos el uno para el otro.</p>
        <div class="bowling-lane" onpointerdown="shootBall()">
            <div class="pins" id="pins">üé≥ üé≥ üé≥</div>
            <div class="bowling-ball-css" id="ball"></div>
        </div>
        <p class="instruction-text">Toca la pista para lanzar la bola</p>
    </div>
    <div class="screen" id="game-s4">
        <h1 class="game-title">Juntos somos fuertes üí™</h1>
        <p class="romantic-text">Entrenando cuerpo y alma para el gran d√≠a.</p>
        <div style="font-size: 4rem;">üèãÔ∏è‚Äç‚ôÇÔ∏è‚ù§Ô∏èüèãÔ∏è‚Äç‚ôÄÔ∏è</div>
        <div class="gym-bar"><div id="gym-fill"></div></div>
        <button class="btn-rsvp" onpointerdown="lift(event)" style="background:var(--pink); border-radius: 50px;">¬°DAR FUERZA!</button>
    </div>
    <div class="screen" id="game-s5">
        <h1 class="game-title">Rumbo a Italia... ‚úàÔ∏è</h1>
        <p class="romantic-text">Bajo el cielo de Florencia...</p>
        <div class="map-area" id="mapZone">
            <svg class="italy-svg" viewBox="0 0 140 250"><path d="M34,44 L55,25 L78,21 L102,40 L97,64 L114,94 L125,127 L132,168 L126,192 L108,206 L94,226 L66,232 L58,212 L69,197 L65,178 L49,166 L45,138 L54,115 L46,90 L34,74 L34,44 Z" fill="#eccc68"/></svg>
            <div id="plane">‚úàÔ∏è</div>
        </div>
        <p class="instruction-text">Arrastra el avi√≥n hasta Italia</p>
    </div>
    <div class="screen" id="game-s6">
        <h1 class="game-title">¬°Lo logramos! üè∞</h1>
        <p class="romantic-text">Madrid ‚ûî Aranjuez. El rinc√≥n perfecto.</p>
        <div style="font-size: 4rem; margin: 20px 0;">üè∞üíçüöô</div>
        <button class="btn-rsvp" onpointerdown="startTransition()" style="background:var(--pink); border-radius: 50px;">ABRIR INVITACI√ìN üíå</button>
    </div>
</div>

<div id="transition-stage">
    <div class="envelope-wrapper" id="envelope">
        <div class="envelope-lid"></div>
        <div class="card-inside"><p>Est√°s invitado/a</p><h2>MARINA & JAIME</h2><p>04.09.2027</p></div>
        <div class="envelope-front"></div>
    </div>
</div>

<div id="invitation-container">
    <div class="grain-overlay"></div>
    <nav>
        <a href="#historia">Nosotros</a>
        <a href="#galeria">Momentos</a>
        <a href="#celebracion">Celebraci√≥n</a>
        <a href="#informacion">Informaci√≥n</a>
        <a href="#rsvp">Confirmar</a>
        <a href="#recuerdos">Mensajes</a>
        <a href="#contacto">Contacto</a>
    </nav>
    
    <header class="main-invitation-header">
        <h1>Marina & Jaime</h1>
        <p>04 ¬∑ Septiembre ¬∑ 2027</p>
    </header>

    <section class="inv-section" id="historia" data-aos="fade-up">
        <h2 class="section-title">Nuestra Historia</h2>
        <div class="story-text">Vuestra historia de amor comienza aqu√≠... una aventura que nos ha tra√≠do hasta este momento tan especial. ¬°Bienvenidos a nuestro gran d√≠a!</div>
    </section>

    <section class="inv-section" id="galeria" data-aos="fade-up">
        <h2 class="section-title">Momentos Juntos</h2>
        <div class="carousel-outer">
            <button class="carousel-btn prev" onpointerdown="scrollTrack('track-fotos', -1)"><i class="fas fa-chevron-left"></i></button>
            <div class="carousel-track" id="track-fotos">
                <img src="foto1.jpg" class="photo-card"><img src="foto2.jpg" class="photo-card"><img src="foto3.jpg" class="photo-card"><img src="foto4.jpg" class="photo-card"><img src="foto5.jpg" class="photo-card">
            </div>
            <button class="carousel-btn next" onpointerdown="scrollTrack('track-fotos', 1)"><i class="fas fa-chevron-right"></i></button>
        </div>
    </section>

    <section class="inv-section" id="celebracion" data-aos="fade-up">
        <h2 class="section-title">Celebraci√≥n</h2>
        <div class="celebracion-info">
            <div class="info-card">
                <span class="info-title"><i class="fa-solid fa-bus"></i> Transporte Autobuses</span>
                <ul class="bus-routes-list">
                    <li><b>Ida</b>Alameda (18:30h) ‚Äî Hotel (18:50h) ‚Äî Cubas</li>
                    <li><b>Vuelta 1</b>Cubas (00:45h) ‚Äî Hotel (00:55h) ‚Äî Alameda</li>
                    <li><b>Vuelta 2</b>Cubas (04:15h) ‚Äî Hotel (04:25h) ‚Äî Alameda</li>
                </ul>
            </div>
            <div class="info-card">
                <span class="info-title"><i class="fa-solid fa-location-dot"></i> Ubicaci√≥n</span>
                <p><b>Finca Las Bocas</b></p>
                <p style="font-size: 0.9rem; color: #666;">28978 Cubas de la Sagra, Madrid</p>
                <div style="height:200px; margin-top:10px; border-radius:8px; overflow:hidden;">
                    <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3051.815343469038!2d-3.8398416234394017!3d40.190906269389924!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0xd4193568c076777%3A0x7d6f6e5a40a6b18a!2sFinca%20Las%20Bocas!5e0!3m2!1ses!2ses!4v1715600000000!5m2!1ses!2ses" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
                </div>
            </div>
        </div>
    </section>

    <section class="inv-section" id="informacion" data-aos="fade-up">
        <h2 class="section-title">Detalles importantes</h2>
        <p style="margin-bottom: 20px; font-style: italic; color: #666;">Para que disfrut√©is al m√°ximo del d√≠a:</p>
        <div class="tips-grid">
            <div class="tip-item">
                <i class="fa-solid fa-shoe-prints"></i>
                <h4>Calzado c√≥modo</h4>
                <p>La ceremonia y la cena ser√°n al aire libre sobre el c√©sped. Os recomendamos evitar los tacones muy finos (o traer vuestros protectores).</p>
            </div>
            <div class="tip-item">
                <i class="fa-solid fa-cloud-moon"></i>
                <h4>Por si refresca</h4>
                <p>Al ser una boda en el campo y al aire libre, cuando caiga el sol puede bajar la temperatura. Un chal o rebequita ser√° vuestro mejor aliado.</p>
            </div>
            <div class="tip-item">
                <i class="fa-solid fa-car"></i>
                <h4>Parking privado</h4>
                <p>Si decid√≠s venir en vuestro propio coche, la finca dispone de un amplio parking privado y gratuito para todos los invitados.</p>
            </div>
        </div>
    </section>

    <section id="rsvp" class="rsvp-section" data-aos="zoom-in">
        <h2 class="section-title">¬øTe apuntas?</h2>
        <button class="btn-rsvp" onpointerdown="document.getElementById('rsvp-modal').style.display='flex'">Confirmar Asistencia</button>
    </section>

    <section class="inv-section" id="recuerdos" data-aos="fade-up">
        <h2 class="section-title">Muro de Recuerdos</h2>
        <div class="carousel-outer">
            <button class="carousel-btn prev" onpointerdown="scrollTrack('track-muro', -1)"><i class="fas fa-chevron-left"></i></button>
            <div class="carousel-track" id="track-muro"></div>
            <button class="carousel-btn next" onpointerdown="scrollTrack('track-muro', 1)"><i class="fas fa-chevron-right"></i></button>
        </div>
    </section>

    <section class="inv-section" id="contacto" data-aos="fade-up" style="margin-bottom: 80px;">
        <h2 class="section-title">Contacto</h2>
        <div style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
            <a href="https://wa.me/34657141165" target="_blank" class="wa-button"><i class="fa-brands fa-whatsapp"></i> Marina</a>
            <a href="https://wa.me/34600000000" target="_blank" class="wa-button"><i class="fa-brands fa-whatsapp"></i> Jaime</a>
        </div>
    </section>

    <div id="rsvp-modal" class="modal-overlay">
        <div class="modal-body">
            <span style="position:absolute; top:15px; right:20px; cursor:pointer; font-size:1.5rem;" onpointerdown="document.getElementById('rsvp-modal').style.display='none'">√ó</span>
            <div id="global-spinner" class="spinner"></div>
            <div id="step-1">
                <h2 class="serif">Busca tu invitaci√≥n</h2>
                <input type="text" id="input-busqueda" placeholder="Nombre o apellido" onkeyup="if(event.key === 'Enter') buscarNombres()" onpointerdown="event.stopPropagation()">
                <button class="btn-rsvp" style="width:100%" onpointerdown="buscarNombres()">Buscar</button>
            </div>
            <div id="step-2" style="display:none;"><div id="lista-nombres"></div></div>
            <div id="step-3" style="display:none;">
                <div id="lista-miembros"></div>
                <button class="btn-rsvp" style="width:100%; margin-top:20px;" onpointerdown="enviarConfirmacion()" id="btn-enviar">Guardar Todo</button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
    let step = 1, lock = false, driveCount = 0;
    const URL_API = "https://script.google.com/macros/s/AKfycbwO_rHe04Hx4aXdnDvVShYmC9EUqq_Ka3Q3CWQjhX_nL3S3opgWiroEs7qLnqI8QUqW/exec";

    function next() {
        if(lock) return; lock = true;
        document.getElementById('game-s'+step).classList.remove('active');
        step++;
        document.getElementById('game-s'+step).classList.add('active');
        setTimeout(() => { lock = false; }, 800);
    }

    function scrollTrack(trackId, direction) {
        const track = document.getElementById(trackId);
        const scrollAmount = track.clientWidth * 0.8;
        track.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
    }

    // JUEGOS
    const tinder = document.getElementById('tinderCard'); let sX = 0;
    const startTinder = (x) => {
        if(step !== 1) return; sX = x;
        const moveH = (ev) => {
            if(sX === 0) return; let curX = ev.touches ? ev.touches[0].clientX : ev.clientX; let dist = curX - sX;
            if(dist > 0) { tinder.style.transform = `translateX(${dist}px) rotate(${dist/15}deg)`; if(dist > 150) { sX = 0; cleanup(); next(); } }
        };
        const cleanup = () => { sX = 0; tinder.style.transform = ''; document.removeEventListener('mousemove', moveH); document.removeEventListener('touchmove', moveH); };
        document.addEventListener('mousemove', moveH); document.addEventListener('touchmove', moveH, { passive: false });
        window.addEventListener('mouseup', cleanup, { once: true }); window.addEventListener('touchend', cleanup, { once: true });
    };
    if(tinder) { tinder.onmousedown = (e) => startTinder(e.clientX); tinder.ontouchstart = (e) => startTinder(e.touches[0].clientX); }

    function drive(e) { if(e) e.preventDefault(); driveCount++; document.getElementById('pCar').style.bottom = (10 + driveCount*10) + 'px'; if(driveCount >= 10) next(); }
    function shootBall() { document.getElementById('ball').style.bottom = "240px"; setTimeout(() => { document.getElementById('pins').innerHTML = "üí• PLENO!"; setTimeout(next, 800); }, 500); }
    let gymP = 0; function lift(e) { if(e) e.preventDefault(); gymP+=20; document.getElementById('gym-fill').style.width = gymP+'%'; if(gymP>=100) next(); }

    const plane = document.getElementById('plane'); const mapZone = document.getElementById('mapZone'); let planeD = false;
    function movePlaneLogic(clientX, clientY) {
        if(!planeD || step !== 5) return; const rect = mapZone.getBoundingClientRect(); let x = clientX - rect.left - 25; let y = clientY - rect.top - 25;
        plane.style.left = x + 'px'; plane.style.top = y + 'px'; if(x > 190 && y < 110) { planeD = false; next(); }
    }
    if(plane) {
        plane.onmousedown = plane.ontouchstart = (e) => { planeD = true; if(e.cancelable) e.preventDefault(); };
        window.addEventListener('mousemove', (e) => movePlaneLogic(e.clientX, e.clientY)); window.addEventListener('touchmove', (e) => movePlaneLogic(e.touches[0].clientX, e.touches[0].clientY), { passive: false });
        window.addEventListener('mouseup', () => planeD = false); window.addEventListener('touchend', () => planeD = false);
    }

    function startTransition() {
        const stage = document.getElementById('transition-stage'); const game = document.getElementById('game-container');
        stage.style.display = 'flex'; requestAnimationFrame(() => { requestAnimationFrame(() => {
            stage.style.opacity = '1'; setTimeout(() => { game.style.display = 'none'; document.getElementById('envelope').classList.add('open');
                setTimeout(() => { stage.style.opacity = '0'; setTimeout(() => { stage.style.display = 'none'; revealFinalInvitation(); }, 550); }, 3200);
            }, 700);
        }); });
    }

    function revealFinalInvitation() { document.body.style.overflow = 'auto'; const inv = document.getElementById('invitation-container'); inv.style.display = 'block'; requestAnimationFrame(() => { inv.style.opacity = '1'; AOS.init({ duration: 1000, once: true }); cargarMuro(); }); }

    // --- RSVP ---
    async function buscarNombres() {
        const bus = document.getElementById("input-busqueda").value.trim(); if(bus.length < 3) return; document.getElementById("global-spinner").style.display = "block";
        try { const res = await fetch(`${URL_API}?action=search&nombre=${encodeURIComponent(bus)}`); const nombres = await res.json();
            document.getElementById("step-1").style.display = "none"; document.getElementById("step-2").style.display = "block";
            document.getElementById("lista-nombres").innerHTML = nombres.map(p => { 
                const haRespondiido = (p.asistencia === "S√≠" || p.asistencia === "No");
                return `<button class="btn-rsvp" style="width:100%; margin-bottom:10px; background:none; color:var(--accent); border:1px solid var(--accent);" onpointerdown="cargarGrupo('${p.id}')">${haRespondiido ? '‚úÖ ' : ''}${p.nombre}</button>`; 
            }).join('');
        } catch(e) { alert("Error"); } document.getElementById("global-spinner").style.display = "none";
    }

    let miembrosGrupo = [];
    async function cargarGrupo(id) {
        document.getElementById("step-2").style.display = "none"; document.getElementById("global-spinner").style.display = "block";
        try { const res = await fetch(`${URL_API}?action=getGroup&groupId=${id}`); miembrosGrupo = await res.json();
            let html = ""; miembrosGrupo.forEach((m, i) => {
                const haRespondiido = (m.asistencia === "S√≠" || m.asistencia === "No");
                html += `<div class="member-accordion">
                    <div class="member-header ${haRespondiido?'completed':''}" id="header-${i}" onpointerdown="toggleMember(${i})"><span>${m.nombre}</span> ${haRespondiido?'<span>‚úÖ Confirmado</span>':'<span>Pendiente</span>'}</div>
                    <div class="member-content" id="content-${i}">
                        <label>¬øAsiste?</label><select class="sel-asistencia" onchange="checkStatus(${i})">
                            <option value="Pendiente" ${(!haRespondiido)?'selected':''}>Pendiente</option>
                            <option value="S√≠" ${m.asistencia==='S√≠'?'selected':''}>S√≠</option>
                            <option value="No" ${m.asistencia==='No'?'selected':''}>No</option>
                        </select>
                        <label>Men√∫</label><select class="sel-menu">
                            <option value="Adulto" ${m.menu==='Adulto'?'selected':''}>Adulto</option>
                            <option value="Ni√±o" ${m.menu==='Ni√±o'?'selected':''}>Ni√±o</option>
                            <option value="Beb√©" ${m.menu==='Beb√©'?'selected':''}>Beb√©</option>
                        </select>
                        <label>Bus Ida</label><select class="sel-bus-ida">
                            <option value="No" ${(!m.bus_ida || m.bus_ida==='No')?'selected':''}>No</option>
                            <option value="S√≠" ${m.bus_ida==='S√≠'?'selected':''}>S√≠</option>
                        </select>
                        <label>Bus Vuelta</label><select class="sel-bus-vuelta">
                            <option value="No" ${(!m.bus_vuelta || m.bus_vuelta==='No')?'selected':''}>No</option>
                            <option value="Vuelta 1 (00:45h)" ${m.bus_vuelta==='Vuelta 1 (00:45h)'?'selected':''}>Vuelta 1 (00:45h)</option>
                            <option value="Vuelta 2 (04:15h)" ${m.bus_vuelta==='Vuelta 2 (04:15h)'?'selected':''}>Vuelta 2 (04:15h)</option>
                        </select>
                        <label>Alergias</label><textarea class="inp-alergia" onpointerdown="event.stopPropagation()">${m.alergias||''}</textarea>
                        <label>Mensaje p√∫blico</label><textarea class="inp-mensaje-web" onpointerdown="event.stopPropagation()">${m.mensajeWeb||''}</textarea>
                        <label>Mensaje privado</label><textarea class="inp-mensaje-privado" onpointerdown="event.stopPropagation()">${m.mensajePrivado||''}</textarea>
                        <button class="btn-copy-settings" onpointerdown="copyToAll(${i})">Copiar todo al grupo</button>
                    </div></div>`;
            });
            document.getElementById("lista-miembros").innerHTML = html; document.getElementById("step-3").style.display = "block";
        } catch(e) { alert("Error"); } document.getElementById("global-spinner").style.display = "none";
    }

    function toggleMember(i) { document.getElementById(`content-${i}`).classList.toggle('open'); }
    function checkStatus(i) { 
        const val = document.querySelectorAll('.sel-asistencia')[i].value; 
        const header = document.getElementById(`header-${i}`); 
        if(val !== "Pendiente") { header.classList.add('completed'); header.querySelector('span:last-child').innerHTML = "‚úÖ Listo"; } 
    }
    
    function copyToAll(idx) {
        const m = document.querySelectorAll('.sel-menu')[idx].value, bi = document.querySelectorAll('.sel-bus-ida')[idx].value, bv = document.querySelectorAll('.sel-bus-vuelta')[idx].value, al = document.querySelectorAll('.inp-alergia')[idx].value, mw = document.querySelectorAll('.inp-mensaje-web')[idx].value, mp = document.querySelectorAll('.inp-mensaje-privado')[idx].value;
        document.querySelectorAll('.sel-menu').forEach(s => s.value = m); document.querySelectorAll('.sel-bus-ida').forEach(s => s.value = bi); document.querySelectorAll('.sel-bus-vuelta').forEach(s => s.value = bv); document.querySelectorAll('.inp-alergia').forEach(s => s.value = al); document.querySelectorAll('.inp-mensaje-web').forEach(s => s.value = mw); document.querySelectorAll('.inp-mensaje-privado').forEach(s => s.value = mp);
        alert("Configuraci√≥n copiada");
    }

    async function enviarConfirmacion() {
        document.getElementById("global-spinner").style.display = "block";
        const updates = miembrosGrupo.map((m, i) => ({ fila: m.fila, asistencia: document.querySelectorAll(".sel-asistencia")[i].value, menu: document.querySelectorAll(".sel-menu")[i].value, bus_ida: document.querySelectorAll(".sel-bus-ida")[i].value, bus_vuelta: document.querySelectorAll(".sel-bus-vuelta")[i].value, alergias: document.querySelectorAll(".inp-alergia")[i].value, mensajeWeb: document.querySelectorAll(".inp-mensaje-web")[i].value, mensajePrivado: document.querySelectorAll(".inp-mensaje-privado")[i].value }));
        try { await fetch(URL_API, { method: "POST", body: JSON.stringify(updates) }); localStorage.setItem('bodaMarinaJaime_CONFIRMADO', 'true'); location.reload(); } catch(e) { alert("Error"); document.getElementById("global-spinner").style.display = "none"; }
    }

    async function cargarMuro() {
        try {
            const res = await fetch(`${URL_API}?action=getMessages`);
            const data = await res.json();
            const track = document.getElementById("track-muro");
            if(data && data.length > 0) {
                const grouped = [];
                data.forEach(m => {
                    const txt = m.texto ? m.texto.trim() : "";
                    if(!txt || txt.toLowerCase() === "pendiente") return;
                    const existing = grouped.find(g => g.texto.toLowerCase() === txt.toLowerCase());
                    const fullNombre = m.nombre ? m.nombre.trim() : "";
                    const primerNombre = fullNombre.split(' ')[0].trim();
                    if(existing) {
                        if(primerNombre && !existing.nombresPila.includes(primerNombre)) existing.nombresPila.push(primerNombre);
                    } else {
                        grouped.push({ texto: txt, nombreOriginal: fullNombre, nombresPila: primerNombre ? [primerNombre] : [] });
                    }
                });
                track.innerHTML = grouped.map(g => {
                    const n = g.nombresPila.filter(n => n.length > 0).length;
                    let firma = (n === 1) ? g.nombreOriginal : (n === 2) ? `${g.nombresPila[0]} y ${g.nombresPila[1]}` : `${g.nombresPila[0]} y familia`;
                    return `<div class="msg-card">"${g.texto}"<br><b>‚Äî ${firma}</b></div>`;
                }).join('');
            }
        } catch(e) {}
    }

    document.body.style.overflow = 'hidden';
    if(localStorage.getItem('bodaMarinaJaime_CONFIRMADO') === 'true') revealFinalInvitation();
</script>
</body>
</html>